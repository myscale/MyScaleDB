From 6df2fd3926a03c0a02cac9f174229029cc1cd3dd Mon Sep 17 00:00:00 2001
From: Shanfeng Pang <shanfengp@moqi.ai>
Date: Wed, 28 Dec 2022 04:42:04 +0000
Subject: [PATCH 025/150] Optimize CI pipline and fix upload/download
 performance package

---
 .gitlab-ci-functional-test.yml                | 30 ++++++----
 .gitlab-ci-integration-test.yml               | 18 ++++--
 .gitlab-ci-memory-leak-test.yml               | 58 +++++++++++++------
 .gitlab-ci-performance-test.yml               | 18 ++++--
 .gitlab-ci.yml                                |  9 ++-
 .../test/mqdb_run_performance/entrypoint.sh   | 14 +----
 tests/integration/exclude_test.list           |  1 +
 7 files changed, 92 insertions(+), 56 deletions(-)

diff --git a/.gitlab-ci-functional-test.yml b/.gitlab-ci-functional-test.yml
index 73273b9e6e..a6d9f1a98c 100644
--- a/.gitlab-ci-functional-test.yml
+++ b/.gitlab-ci-functional-test.yml
@@ -1,8 +1,10 @@
 ######################################## VECTOR TESTS ########################################
 ######### VECTOR TESTS ###########
 vector_search_test:
-  stage: vs_test
-  dependencies: ["build_binary"]
+  stage: functional-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   parallel:
     matrix:
       - ARCH: amd64
@@ -18,8 +20,10 @@ vector_search_test:
 ###################################### FUNCTIONAL TESTS ######################################
 ########## SMOKE TESTS ###########
 smoke_test:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: functional-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-smoke:1.0
   parallel:
     matrix:
@@ -41,8 +45,10 @@ smoke_test:
 ### FUNCTIONAL STATELESS TESTS ###
 # TODO Split stateless/stateful tests pipline
 stateless_test:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: functional-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-stateless-test"
     paths:
@@ -63,8 +69,10 @@ stateless_test:
     - if: '$CI_TEST_VECTOR_DB != "true"'
 ### FUNCTIONAL STATEFUL TESTS ####
 stateful_test:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: functional-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-stateful-test"
     paths:
@@ -85,8 +93,10 @@ stateful_test:
     - if: '$CI_TEST_VECTOR_DB != "true"'
 ####### AST FUZZER TESTS #########
 fuzzer_test:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: functional-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-fuzz:1.0
   parallel:
     matrix:
diff --git a/.gitlab-ci-integration-test.yml b/.gitlab-ci-integration-test.yml
index 6aace01282..6f9c345ed7 100644
--- a/.gitlab-ci-integration-test.yml
+++ b/.gitlab-ci-integration-test.yml
@@ -1,7 +1,9 @@
 ######################################## INTEGRATION TESTS ###################################
 integration_test0:
-  stage: test
-  dependencies: ["build_for_integration_test"]
+  stage: failover-test
+  needs: 
+    - job: build_for_integration_test
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-integration:1.0
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-integration0"
@@ -15,8 +17,10 @@ integration_test0:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"'    # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-integration"
 integration_test1:
-  stage: test
-  dependencies: ["build_for_integration_test"]
+  stage: failover-test
+  needs: 
+    - job: build_for_integration_test
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-integration:1.0
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-integration1"
@@ -30,8 +34,10 @@ integration_test1:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"'    # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-integration"
 integration_test2:
-  stage: test
-  dependencies: ["build_for_integration_test"]
+  stage: failover-test
+  needs: 
+    - job: build_for_integration_test
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-integration:1.0
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-integration2"
diff --git a/.gitlab-ci-memory-leak-test.yml b/.gitlab-ci-memory-leak-test.yml
index 7d087bf9e6..636a04661b 100644
--- a/.gitlab-ci-memory-leak-test.yml
+++ b/.gitlab-ci-memory-leak-test.yml
@@ -1,8 +1,10 @@
 ########## STRESS TESTS ##########
 # TODO build test image for arm64
 stress_test_asan:
-  stage: test
-  dependencies: ["build_with_sanitizer_asanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_asanbinary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-stress:1.1
   parallel:
     matrix:
@@ -23,8 +25,10 @@ stress_test_asan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 stress_test_tsan:
-  stage: test
-  dependencies: ["build_with_sanitizer_tsanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_tsanbinary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-stress:1.1
   parallel:
     matrix:
@@ -45,8 +49,10 @@ stress_test_tsan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"'  # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 stress_test_ubsan:
-  stage: test
-  dependencies: ["build_with_sanitizer_ubsanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_ubsanbinary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-stress:1.1
   parallel:
     matrix:
@@ -67,8 +73,10 @@ stress_test_ubsan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 stress_test_msan:
-  stage: test
-  dependencies: ["build_with_sanitizer_msanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_msanbinary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-stress:1.1
   parallel:
     matrix:
@@ -89,8 +97,10 @@ stress_test_msan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 vector-test-asan:
-  stage: test
-  dependencies: ["build_with_sanitizer_asanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_asanbinary
+      artifacts: true
   parallel:
     matrix:
       - ARCH: amd64
@@ -115,7 +125,9 @@ vector-test-asan:
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 # vector-test-tsan:
 #   stage: test
-#   dependencies: ["build_with_sanitizer_tsanbinary"]
+#   needs: 
+#    - job: build_with_sanitizer_tsanbinary
+#      artifacts: true
 #   parallel:
 #     matrix:
 #       - ARCH: amd64
@@ -137,8 +149,10 @@ vector-test-asan:
 #     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
 #     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 vector-test-msan:
-  stage: test
-  dependencies: ["build_with_sanitizer_msanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_msanbinary
+      artifacts: true
   parallel:
     matrix:
       - ARCH: amd64
@@ -162,8 +176,10 @@ vector-test-msan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 vector-test-ubsan:
-  stage: test
-  dependencies: ["build_with_sanitizer_ubsanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_ubsanbinary
+      artifacts: true
   parallel:
     matrix:
       - ARCH: amd64
@@ -187,8 +203,10 @@ vector-test-ubsan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 fuzzer_test-asan:
-  stage: test
-  dependencies: ["build_with_sanitizer_asanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_asanbinary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-fuzz:1.0
   parallel:
     matrix:
@@ -209,8 +227,10 @@ fuzzer_test-asan:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-memory-leak"
 fuzzer_test-ubsan:
-  stage: test
-  dependencies: ["build_with_sanitizer_ubsanbinary"]
+  stage: memory-leak-test
+  needs: 
+    - job: build_with_sanitizer_ubsanbinary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-fuzz:1.0
   parallel:
     matrix:
diff --git a/.gitlab-ci-performance-test.yml b/.gitlab-ci-performance-test.yml
index 3ff3933dee..2783073464 100644
--- a/.gitlab-ci-performance-test.yml
+++ b/.gitlab-ci-performance-test.yml
@@ -1,7 +1,9 @@
 ####################################### PERFORMANCE TESTS ####################################
 performance_test0:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: performance-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-performance:1.0
   parallel:
     matrix:
@@ -21,8 +23,10 @@ performance_test0:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-performance"
 performance_test1:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: performance-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-performance:1.0
   parallel:
     matrix:
@@ -42,8 +46,10 @@ performance_test1:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB != "true"' # Trigger pipline during scheduled tasks
     - if: $CI_MERGE_REQUEST_LABELS == "test-performance"
 performance_test2:
-  stage: test
-  dependencies: ["build_binary"]
+  stage: performance-test
+  needs: 
+    - job: build_binary
+      artifacts: true
   image: harbor.internal.moqi.ai/mqdb/mqdb-test-performance:1.0
   parallel:
     matrix:
diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index c92fca21dd..1f3a23b34d 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -8,8 +8,10 @@ include:
 
 stages:
   - build
-  - vs_test
-  - test
+  - functional-test
+  - performance-test
+  - failover-test
+  - memory-leak-test
   - package
   - image
   - deploy
@@ -82,7 +84,7 @@ build_image:
     - docker/builder/tools/image.sh
 upload_performance_file_to_s3:
   stage: deploy
-  dependencies: ["build_for_integration_test"]
+  dependencies: ["build_binary"]
   image:
     name: minio/mc
     entrypoint: [""]
@@ -92,6 +94,7 @@ upload_performance_file_to_s3:
     - mkdir -pv ~/.mc
     - cp -fv $mc_config ~/.mc/config.json
   script:
+    - mc cp artifacts/performance_pack_amd64.tar.gz cos/mqdb-release-1253802058/performance/performance_pack_amd64_${CI_COMMIT_SHORT_SHA}.tar.gz
     - mc cp artifacts/performance_pack_amd64.tar.gz cos/mqdb-release-1253802058/performance/performance_pack_amd64.tar.gz
 # deploy_to_staging:
 #   stage: deploy
diff --git a/docker/test/mqdb_run_performance/entrypoint.sh b/docker/test/mqdb_run_performance/entrypoint.sh
index 6f291aaa98..1526d0b552 100755
--- a/docker/test/mqdb_run_performance/entrypoint.sh
+++ b/docker/test/mqdb_run_performance/entrypoint.sh
@@ -22,7 +22,7 @@ function download_left_package
 {
     # $WORKPATH/s3downloader --url-prefix "https://mqdb-release.moqi.com.cn/" --dataset-names "performance_package" --clickhouse-data-path "$WORKPATH/workspace"
     # TODO: Modified to download according to the commit number
-    wget https://mqdb-release.moqi.com.cn/performance/performance_pack_amd64.tar.gz -O left.tar.gz
+    wget https://mqdb-release.moqi.com.cn/performance/performance_pack_amd64_${1}.tar.gz -O left.tar.gz || wget https://mqdb-release.moqi.com.cn/performance/performance_pack_amd64.tar.gz -O left.tar.gz
     tar -zxvf left.tar.gz -C $WORKPATH/workspace
     mv $WORKPATH/workspace/performance_pack $WORKPATH/workspace/left
 }
@@ -107,25 +107,17 @@ chmod 777 workspace output
 
 cd workspace
 
-# url_build_binary=$(Download_Url)
-# Download the package for the version we are going to test.
-# if curl_with_retry $url_build_binary
-# then
-#     right_path=$url_build_binary
-# fi
-
 if [[ ! -f "right/clickhouse" ]]; then
     # cp -rf $comp_file/right/* right/.
     rm -rf right ||:
     tar -xzf $WORKPATH/tests/performance_pack_right.tar.gz
     mv performance_pack right
 fi
+
 if [[ ! -f "left/clickhouse" ]]; then
     # cp -rf $comp_file/left/* left/.
     rm -rf left ||:
-    # tar -xzf $WORKPATH/tests/performance_pack_left.tar.gz
     download_left_package
-    # mv performance_pack left
 fi
 ls -al right
 ls -al left
@@ -176,10 +168,8 @@ echo "enrtypoint_end"
 
 # Start the main comparison script.
 { \
-    # time "$script_path"/download.sh "$REF_PR" "$REF_SHA" "$PR_TO_TEST" "$SHA_TO_TEST";
     time ../download.sh && \
     time stage=configure ../compare.sh ; \
-    # time stage=configure "$script_path"/compare.sh ; \
 } 2>&1 | ts "$(printf '%%Y-%%m-%%d %%H:%%M:%%S\t')" | tee compare.log
 
 # Stop the servers to free memory. Normally they are restarted before getting
diff --git a/tests/integration/exclude_test.list b/tests/integration/exclude_test.list
index db1548c609..d981ec9304 100644
--- a/tests/integration/exclude_test.list
+++ b/tests/integration/exclude_test.list
@@ -5,6 +5,7 @@ test_config_xml_main
 test_config_xml_yaml_mix
 test_config_yaml_full
 test_config_yaml_main
+test_dictionaries_redis
 test_distributed_backward_compatability
 test_distributed_insert_backward_compatibility
 test_groupBitmapAnd_on_distributed
-- 
2.32.1 (Apple Git-133)

