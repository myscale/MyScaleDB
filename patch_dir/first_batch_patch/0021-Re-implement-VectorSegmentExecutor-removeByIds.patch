From 785559519013c0a8aa336da08fcd29a8847e8334 Mon Sep 17 00:00:00 2001
From: Qin Liu <qliu@moqi.ai>
Date: Mon, 26 Dec 2022 12:13:37 +0000
Subject: [PATCH 021/150] Re-implement VectorSegmentExecutor::removeByIds

---
 contrib/faiss                                          |  2 +-
 contrib/hnswlib                                        |  2 +-
 src/VectorIndex/VectorSegmentExecutor.cpp              | 10 +++++++++-
 .../2_vector_search/00008_mqvs_empty_vector.reference  | 10 ++++++++++
 .../queries/2_vector_search/00008_mqvs_empty_vector.sh |  7 +++++++
 5 files changed, 28 insertions(+), 3 deletions(-)

diff --git a/contrib/faiss b/contrib/faiss
index 631d7d8d46..3919ad1b2f 160000
--- a/contrib/faiss
+++ b/contrib/faiss
@@ -1 +1 @@
-Subproject commit 631d7d8d46f302c5a24a123fc6550ecb684a0d2a
+Subproject commit 3919ad1b2f1ae8387e78763fdfff2a79e85d9e87
diff --git a/contrib/hnswlib b/contrib/hnswlib
index a6ac4e52e8..766013341a 160000
--- a/contrib/hnswlib
+++ b/contrib/hnswlib
@@ -1 +1 @@
-Subproject commit a6ac4e52e8bff990496d69638ee8e09412f3bd00
+Subproject commit 766013341aea209730198daee80a8c71ec32b249
diff --git a/src/VectorIndex/VectorSegmentExecutor.cpp b/src/VectorIndex/VectorSegmentExecutor.cpp
index c0ca9dab65..5a72ccbf83 100644
--- a/src/VectorIndex/VectorSegmentExecutor.cpp
+++ b/src/VectorIndex/VectorSegmentExecutor.cpp
@@ -945,7 +945,15 @@ Status VectorSegmentExecutor::cancelBuild()
 Status VectorSegmentExecutor::removeByIds(int64_t n, int64_t * ids)
 {
     LOG_INFO(log, "need to remove {} ids", n);
-    int64_t removed = index->removeWithIds(n, ids);
+    int64_t removed = 0;
+    for (int64_t i = 0; i < n; i++)
+    {
+        if (delete_bitmap->test(ids[i]))
+        {
+            removed++;
+            delete_bitmap->unset(ids[i]);
+        }
+    }
     LOG_INFO(log, "removed {} ids", removed);
     if (removed == n)
     {
diff --git a/tests/queries/2_vector_search/00008_mqvs_empty_vector.reference b/tests/queries/2_vector_search/00008_mqvs_empty_vector.reference
index 5b7c6d80ce..7ca3093bf6 100644
--- a/tests/queries/2_vector_search/00008_mqvs_empty_vector.reference
+++ b/tests/queries/2_vector_search/00008_mqvs_empty_vector.reference
@@ -8,3 +8,13 @@
 34	[34,34,34]	588
 6	[6,6,6]	588
 5	[5,5,5]	675
+30	[30,30,30]	300
+31	[31,31,31]	363
+9	[9,9,9]	363
+8	[8,8,8]	432
+32	[32,32,32]	432
+33	[33,33,33]	507
+7	[7,7,7]	507
+34	[34,34,34]	588
+6	[6,6,6]	588
+5	[5,5,5]	675
diff --git a/tests/queries/2_vector_search/00008_mqvs_empty_vector.sh b/tests/queries/2_vector_search/00008_mqvs_empty_vector.sh
index e0a1035f0b..7b9f2958d4 100755
--- a/tests/queries/2_vector_search/00008_mqvs_empty_vector.sh
+++ b/tests/queries/2_vector_search/00008_mqvs_empty_vector.sh
@@ -4,4 +4,11 @@
 CURDIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
 . "$CURDIR"/helpers/00000_prepare_data_with_empty_vectors.sh
 
+# test empty vector with IVFFLAT
+clickhouse-client -q "SELECT id, vector, distance('topK = 10')(vector, [20.0, 20.0, 20.0]) FROM test_vector;"
+
+# test empty vector with FLAT
+clickhouse-client -q "ALTER TABLE test_vector DROP VECTOR INDEX v1;"
+clickhouse-client -q "ALTER TABLE test_vector ADD VECTOR INDEX v1 vector TYPE FLAT;"
+sleep 1
 clickhouse-client -q "SELECT id, vector, distance('topK = 10')(vector, [20.0, 20.0, 20.0]) FROM test_vector;"
-- 
2.32.1 (Apple Git-133)

