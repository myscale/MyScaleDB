From 0beafa2dd86484fed62d17313874e2a7b216d846 Mon Sep 17 00:00:00 2001
From: Jianmei Zhang <jianmeiz@moqi.ai>
Date: Tue, 6 Dec 2022 03:13:55 +0000
Subject: [PATCH 009/150] Fix stateless test failures due to lightweight delete
 + vector

---
 .../MergeTree/MergeTreeBaseSelectProcessor.cpp  |  6 +++++-
 src/VectorIndex/MergeUtils.h                    |  6 +++++-
 ..._lightweight_delete_vertical_merge.reference |  2 +-
 .../02404_lightweight_delete_vertical_merge.sql |  2 +-
 .../queries/2_vector_search/prepare_index_5.sh  | 17 -----------------
 .../queries/2_vector_search/prepare_index_6.sh  | 15 ---------------
 .../2_vector_search/prepare_index_cosine.sh     | 16 ----------------
 .../prepare_index_cosine_ivfpq.sh               | 15 ---------------
 8 files changed, 12 insertions(+), 67 deletions(-)
 delete mode 100644 tests/queries/2_vector_search/prepare_index_5.sh
 delete mode 100644 tests/queries/2_vector_search/prepare_index_6.sh
 delete mode 100644 tests/queries/2_vector_search/prepare_index_cosine.sh
 delete mode 100644 tests/queries/2_vector_search/prepare_index_cosine_ivfpq.sh

diff --git a/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp b/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp
index 63c5e8ced3..f646b856e9 100644
--- a/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp
+++ b/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp
@@ -589,7 +589,11 @@ MergeTreeBaseSelectProcessor::BlockAndRowCount MergeTreeBaseSelectProcessor::rea
 
     /// Remove distance_func column from read_result.columns, it will be added by vector search.
     Columns ordered_columns;
-    ordered_columns.reserve(sample_block.columns() - 1);
+    if (task->vector_scan_manager)
+        ordered_columns.reserve(sample_block.columns() - 1);
+    else
+        ordered_columns.reserve(sample_block.columns());
+
     size_t which_cut = 0;
     String vector_scan_col_name;
     for (size_t ps = 0; ps < sample_block.columns(); ++ps)
diff --git a/src/VectorIndex/MergeUtils.h b/src/VectorIndex/MergeUtils.h
index 68f62f0543..f65a9728ee 100644
--- a/src/VectorIndex/MergeUtils.h
+++ b/src/VectorIndex/MergeUtils.h
@@ -74,7 +74,11 @@ static bool containRowIdsMaps(const String& data_path)
 
 static bool containRowIdsMaps(const std::shared_ptr<const DB::IMergeTreeDataPart>& part)
 {
-    return containRowIdsMaps(part->getFullPath());
+    /// Skip to check disk for in-memory part
+    if (!part->isStoredOnDisk())
+        return false;
+    else
+       return containRowIdsMaps(part->getFullPath());
 }
 
 static void removeAllRowIdsMaps(const String& data_path)
diff --git a/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.reference b/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.reference
index df57ef39d4..d57e99412b 100644
--- a/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.reference
+++ b/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.reference
@@ -144,4 +144,4 @@ all_5_5_0_6	value	String	10
 9	209
 all_1_5_3_6	Wide
 all_1_5_3_6	id	UInt64	16
-all_1_5_3_6	value	String	16
\ No newline at end of file
+all_1_5_3_6	value	String	16
diff --git a/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.sql b/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.sql
index 3997992165..970db50282 100644
--- a/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.sql
+++ b/tests/queries/0_stateless/02404_lightweight_delete_vertical_merge.sql
@@ -181,4 +181,4 @@ WHERE (database = currentDatabase()) AND (table = 'lwd_test') AND active
 ORDER BY name, column;
 
 
-DROP TABLE lwd_test;
\ No newline at end of file
+DROP TABLE lwd_test;
diff --git a/tests/queries/2_vector_search/prepare_index_5.sh b/tests/queries/2_vector_search/prepare_index_5.sh
deleted file mode 100644
index 4972cd4f68..0000000000
--- a/tests/queries/2_vector_search/prepare_index_5.sh
+++ /dev/null
@@ -1,17 +0,0 @@
-clickhouse-client -q "DROP TABLE IF EXISTS test_vector"
-clickhouse-client -q "CREATE TABLE test_vector(id Float32, vector FixedArray(Float32, 3)) engine MergeTree primary key id SETTINGS index_granularity=1024;"
-clickhouse-client -q "INSERT INTO test_vector SELECT number, [number, number, number] FROM numbers(10000);"
-clickhouse-client -q "INSERT INTO test_vector SELECT number + 10000, [number + 10000, number + 10000, number + 10000] FROM numbers(10000);"
-clickhouse-client -q "INSERT INTO test_vector SELECT number + 20000, [number + 20000, number + 20000, number + 20000] FROM numbers(10000);"
-clickhouse-client -q "ALTER TABLE test_vector ADD VECTOR INDEX v1 vector TYPE IVFFLAT;"
-status="NotBuilt"
-time=0
-while [[ $status != "Built" && $time != 5 ]]
-do
-        status=`clickhouse-client -q "select status from system.vector_indices where table = 'test_vector' and name = 'v1';"`
-        sleep 1
-        ((++time))
-done
-if [ $time -eq 5 ]; then
-        echo "fail to build index"
-fi
diff --git a/tests/queries/2_vector_search/prepare_index_6.sh b/tests/queries/2_vector_search/prepare_index_6.sh
deleted file mode 100644
index f23375faa3..0000000000
--- a/tests/queries/2_vector_search/prepare_index_6.sh
+++ /dev/null
@@ -1,15 +0,0 @@
-clickhouse-client -q "DROP TABLE IF EXISTS test_vector"
-clickhouse-client -q "CREATE TABLE test_vector(id Float32, vector FixedArray(Float32, 3)) engine MergeTree primary key id SETTINGS index_granularity=1024;"
-clickhouse-client -q "INSERT INTO test_vector SELECT number, [number, number, number] FROM numbers(5000);"
-clickhouse-client -q "ALTER TABLE test_vector ADD VECTOR INDEX v1 vector TYPE HNSWFLAT;"
-status="NotBuilt"
-time=0
-while [[ $status != "Built" && $time != 5 ]]
-do
-        status=`clickhouse-client -q "select status from system.vector_indices where table = 'test_vector' and name = 'v1';"`
-        sleep 1
-        ((++time))
-done
-if [ $time -eq 5 ]; then
-        echo "fail to build index"
-fi
diff --git a/tests/queries/2_vector_search/prepare_index_cosine.sh b/tests/queries/2_vector_search/prepare_index_cosine.sh
deleted file mode 100644
index 078142e536..0000000000
--- a/tests/queries/2_vector_search/prepare_index_cosine.sh
+++ /dev/null
@@ -1,16 +0,0 @@
-INDEX_TYPE=$1
-clickhouse-client -q "DROP TABLE IF EXISTS test_vector"
-clickhouse-client -q "CREATE TABLE test_vector(id Float32, vector FixedArray(Float32, 4)) engine MergeTree primary key id SETTINGS index_granularity=1024;"
-clickhouse-client -q "INSERT INTO test_vector select number, [number / pow(number, 2), number / pow(number, 2), number / pow(number, 2), sqrt(1 - 3 * pow(number / pow(number, 2), 2))] from numbers(4000) where number > 1;"
-clickhouse-client -q "ALTER TABLE test_vector ADD VECTOR INDEX v1 vector TYPE $INDEX_TYPE('metric_type=cosine');"
-status="NotBuilt"
-time=0
-while [[ $status != "Built" && $time != 10 ]]
-do
-        status=`clickhouse-client -q "select status from system.vector_indices where table = 'test_vector' and name = 'v1';"`
-        sleep 1
-        ((++time))
-done
-if [ $time -eq 10 ]; then
-        echo "fail to build index"
-fi
diff --git a/tests/queries/2_vector_search/prepare_index_cosine_ivfpq.sh b/tests/queries/2_vector_search/prepare_index_cosine_ivfpq.sh
deleted file mode 100644
index 80ee0cabe1..0000000000
--- a/tests/queries/2_vector_search/prepare_index_cosine_ivfpq.sh
+++ /dev/null
@@ -1,15 +0,0 @@
-clickhouse-client -q "DROP TABLE IF EXISTS test_vector"
-clickhouse-client -q "CREATE TABLE test_vector(id Float32, vector FixedArray(Float32, 4)) engine MergeTree primary key id SETTINGS index_granularity=1024;"
-clickhouse-client -q "INSERT INTO test_vector select number, [number / pow(number, 2), number / pow(number, 2), number / pow(number, 2), sqrt(1 - 3 * pow(number / pow(number, 2), 2))] from numbers(4000) where number > 1;"
-clickhouse-client -q "ALTER TABLE test_vector ADD VECTOR INDEX v1 vector TYPE IVFPQ('M = 4', 'metric_type=cosine');"
-status="NotBuilt"
-time=0
-while [[ $status != "Built" && $time != 10 ]]
-do
-        status=`clickhouse-client -q "select status from system.vector_indices where table = 'test_vector' and name = 'v1';"`
-        sleep 1
-        ((++time))
-done
-if [ $time -eq 10 ]; then
-        echo "fail to build index"
-fi
-- 
2.32.1 (Apple Git-133)

