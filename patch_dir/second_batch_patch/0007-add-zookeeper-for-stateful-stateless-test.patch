From 56a6d03724e1b863db969c97e8a82e414fd8d20e Mon Sep 17 00:00:00 2001
From: Shanfeng Pang <shanfengp@moqi.ai>
Date: Fri, 30 Dec 2022 08:20:08 +0000
Subject: [PATCH 07/85] add zookeeper for stateful/stateless test

---
 docker/test/mqdb_run_stateful/Dockerfile   |  2 +-
 docker/test/mqdb_run_stateful/run.sh       | 11 +++++++++++
 docker/test/mqdb_run_stateless/Dockerfile  |  2 +-
 docker/test/mqdb_run_stateless/run.sh      | 10 ++++++++++
 docker/test/mqdb_test_base/Dockerfile      | 16 +++++++++++++++-
 docker/test/mqdb_test_stateless/Dockerfile |  4 ++--
 6 files changed, 40 insertions(+), 5 deletions(-)

diff --git a/docker/test/mqdb_run_stateful/Dockerfile b/docker/test/mqdb_run_stateful/Dockerfile
index 16910bb95b..ca83aa70ac 100644
--- a/docker/test/mqdb_run_stateful/Dockerfile
+++ b/docker/test/mqdb_run_stateful/Dockerfile
@@ -1,7 +1,7 @@
 # docker build -t run-stateful-test .
 # docker run -it -v /home/ubuntu/workspace/ClickHouse/tests/ci/packages:/package_folder -v /home/ubuntu/workspace/ClickHouse/tests/ci/result_path:/test_output -v /home/ubuntu/workspace/ClickHouse/tests/ci/server_log:/var/log/clickhouse-server  --user root --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time" -d --name stateful-test mqdb-stateful-test
 
-FROM harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.1 
+FROM harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.2 
 
 COPY packages /package_folder
 COPY s3downloader /s3downloader
diff --git a/docker/test/mqdb_run_stateful/run.sh b/docker/test/mqdb_run_stateful/run.sh
index a03591f6d7..e5f0d55017 100755
--- a/docker/test/mqdb_run_stateful/run.sh
+++ b/docker/test/mqdb_run_stateful/run.sh
@@ -25,6 +25,17 @@ chmod a+x /usr/bin/clickhouse-test
 /usr/share/clickhouse-test/config/install.sh
 rm -rf /etc/clickhouse-server/config.d/listen.xml
 echo '<clickhouse><listen_host>0.0.0.0</listen_host></clickhouse>' >>/etc/clickhouse-server/config.d/listen.xml
+sed -i "s/9181/2181/" /etc/clickhouse-server/config.d/zookeeper.xml
+rm -rf /etc/clickhouse-server/config.d/keeper_port.xml
+function setup_zookeeper
+{
+    $ZOOKEEPER_BIN_PATH/zkServer.sh start
+    sleep 10
+    $ZOOKEEPER_BIN_PATH/zkServer.sh status
+    # lsof -i | grep 2181
+}
+
+setup_zookeeper
 
 function start() {
     if [[ -n "$USE_DATABASE_REPLICATED" ]] && [[ "$USE_DATABASE_REPLICATED" -eq 1 ]]; then
diff --git a/docker/test/mqdb_run_stateless/Dockerfile b/docker/test/mqdb_run_stateless/Dockerfile
index c6ac7e2027..7acb019d77 100644
--- a/docker/test/mqdb_run_stateless/Dockerfile
+++ b/docker/test/mqdb_run_stateless/Dockerfile
@@ -1,6 +1,6 @@
 #docker build -t run-stateless-test .
 #docker run -it --user root --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time" --name test mqdb-stateless-test 
-FROM harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.1
+FROM harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.2
 COPY packages /package_folder
 ADD clickhouse-test /usr/bin
 COPY run.sh /
diff --git a/docker/test/mqdb_run_stateless/run.sh b/docker/test/mqdb_run_stateless/run.sh
index 5f969780a8..3deabd9df3 100644
--- a/docker/test/mqdb_run_stateless/run.sh
+++ b/docker/test/mqdb_run_stateless/run.sh
@@ -25,9 +25,19 @@ chmod a+x /usr/bin/clickhouse-test
 /usr/share/clickhouse-test/config/install.sh
 rm -rf /etc/clickhouse-server/config.d/listen.xml
 echo '<clickhouse><listen_host>0.0.0.0</listen_host></clickhouse>' >>/etc/clickhouse-server/config.d/listen.xml
+sed -i "s/9181/2181/" /etc/clickhouse-server/config.d/zookeeper.xml
+rm -rf /etc/clickhouse-server/config.d/keeper_port.xml
 # cp -r clickhouse-test /usr/bin/clickhouse-test
 ./setup_minio.sh
 
+function setup_zookeeper
+{
+    $ZOOKEEPER_BIN_PATH/zkServer.sh start
+    sleep 10
+    $ZOOKEEPER_BIN_PATH/zkServer.sh status
+}
+setup_zookeeper
+
 # For flaky check we also enable thread fuzzer
 if [ "$NUM_TRIES" -gt "1" ]; then
     export THREAD_FUZZER_CPU_TIME_PERIOD_US=1000
diff --git a/docker/test/mqdb_test_base/Dockerfile b/docker/test/mqdb_test_base/Dockerfile
index ed8296818d..4132face7c 100644
--- a/docker/test/mqdb_test_base/Dockerfile
+++ b/docker/test/mqdb_test_base/Dockerfile
@@ -54,8 +54,22 @@ RUN apt-get update -y \
     unixodbc \
     mysql-client \
     postgresql-client \
-    sqlite3
+    sqlite3 \
+    openjdk-8-jdk
 RUN pip install numpy scipy pandas Jinja2 -i https://pypi.tuna.tsinghua.edu.cn/simple/
 COPY process_functional_tests_result.py /
 
+ARG TARGETARCH
+
+# Download zookeeper
+# wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz 
+COPY zookeeper-3.4.9.tar.gz /opt/zookeeper-3.4.9.tar.gz
+RUN tar -xzvf /opt/zookeeper-3.4.9.tar.gz -C /opt/ \
+    && mv /opt/zookeeper-3.4.9 /opt/zookeeper
+RUN cp /opt/zookeeper/conf/zoo_sample.cfg /opt/zookeeper/conf/zoo.cfg
+
+ENV ZOOKEEPER_BIN_PATH=/opt/zookeeper/bin
+ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-${TARGETARCH:-amd64}
+ENV PATH=${JAVA_HOME}/bin:$PATH
+
 CMD sleep 1
diff --git a/docker/test/mqdb_test_stateless/Dockerfile b/docker/test/mqdb_test_stateless/Dockerfile
index 0c1f594a23..b0a2da5195 100644
--- a/docker/test/mqdb_test_stateless/Dockerfile
+++ b/docker/test/mqdb_test_stateless/Dockerfile
@@ -1,6 +1,6 @@
 # docker build -t harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.1 .
-# docker buildx build --platform linux/amd64,linux/arm64 -t harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.1 . --push
-FROM harbor.internal.moqi.ai/mqdb/mqdb-test-base:1.1
+# docker buildx build --platform linux/amd64,linux/arm64 -t harbor.internal.moqi.ai/mqdb/mqdb-test-stateless:1.2 . --push
+FROM harbor.internal.moqi.ai/mqdb/mqdb-test-base:1.2
 
 ARG TARGETARCH
 
-- 
2.32.1 (Apple Git-133)

