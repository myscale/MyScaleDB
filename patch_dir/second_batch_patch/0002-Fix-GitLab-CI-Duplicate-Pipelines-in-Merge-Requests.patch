From 966abd8bcb676dd93351e4bb344ebfa410c03a31 Mon Sep 17 00:00:00 2001
From: Qin Liu <lqgy2001@gmail.com>
Date: Wed, 28 Dec 2022 23:40:23 +0800
Subject: [PATCH 02/85] Fix GitLab CI Duplicate Pipelines in Merge Requests

See https://medium.com/devops-with-valentine/fix-gitlab-ci-duplicate-pipelines-in-merge-requests-when-using-rules-9a1486994f3a
for details
---
 .gitlab-ci-performance-test.yml |  2 +-
 .gitlab-ci.yml                  | 34 +++++++++++++--------------------
 2 files changed, 14 insertions(+), 22 deletions(-)

diff --git a/.gitlab-ci-performance-test.yml b/.gitlab-ci-performance-test.yml
index 2783073464..58a977c7a7 100644
--- a/.gitlab-ci-performance-test.yml
+++ b/.gitlab-ci-performance-test.yml
@@ -97,4 +97,4 @@ vector_db_test:
     - timeout 300 kubectl logs -f $WORK_POD_NAME
   rules:
   # [TODO] Add more policy
-    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB == "true" && $CI_COMMIT_BRANCH == "mqdb-dev"'    # Trigger pipline during scheduled tasks
\ No newline at end of file
+    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_VECTOR_DB == "true" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'    # Trigger pipline during scheduled tasks
diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index 12ce822171..ca9f6255dc 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -1,3 +1,8 @@
+workflow:
+  rules:
+    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
+    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
+
 image: harbor.internal.moqi.ai/mqdb/builder:2.1
 include:
   - '/.gitlab-ci-build.yml'
@@ -35,11 +40,6 @@ build_package:
     KUBERNETES_CPU_LIMIT: 32
     KUBERNETES_MEMORY_REQUEST: 16Gi
     KUBERNETES_MEMORY_LIMIT: 32Gi
-  only:
-    - mqdb-master
-    - mqdb-staging
-    - mqdb-dev
-    - merge_requests
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-without-license"
     paths:
@@ -58,9 +58,8 @@ build_package_with_license:
     KUBERNETES_CPU_LIMIT: 32
     KUBERNETES_MEMORY_REQUEST: 16Gi
     KUBERNETES_MEMORY_LIMIT: 32Gi
-  only:
-    - mqdb-master
-    - mqdb-staging
+  rules:
+    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
   artifacts:
     name: "mqdb-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA-with-license"
     paths:
@@ -74,11 +73,6 @@ build_package_with_license:
 build_image:
   stage: image
   dependencies: ["build_package"]
-  only:
-    - mqdb-master
-    - mqdb-staging
-    - mqdb-dev
-    - merge_requests
   before_script:
     - docker/builder/tools/docker-info.sh
     - docker/builder/tools/docker-buildx.sh
@@ -90,8 +84,8 @@ upload_performance_file_to_s3:
   image:
     name: minio/mc
     entrypoint: [""]
-  only:
-    - mqdb-dev
+  rules:
+    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
   before_script:
     - mkdir -pv ~/.mc
     - cp -fv $mc_config ~/.mc/config.json
@@ -101,9 +95,8 @@ upload_performance_file_to_s3:
 # deploy_to_staging:
 #   stage: deploy
 #   dependencies: ["build_x86_64_package"]
-#   only:
-#     - mqdb-master
-#     - mqdb-staging
+#   rules:
+#     - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
 #   variables:
 #     deploy_to_host: 10.10.1.48
 #   script:
@@ -120,9 +113,8 @@ upload_performance_file_to_s3:
 #   image:
 #     name: minio/mc
 #     entrypoint: [""]
-#   only:
-#     - mqdb-master
-#     - mqdb-staging
+#   rules:
+#     - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
 #   before_script:
 #     - mkdir -pv ~/.mc
 #     - cp -fv $mc_config ~/.mc/config.json
-- 
2.32.1 (Apple Git-133)

