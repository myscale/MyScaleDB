From b47fb715486616f5d88e2533b2cc7bc3be11927e Mon Sep 17 00:00:00 2001
From: Qin Liu <lqgy2001@gmail.com>
Date: Fri, 3 Feb 2023 19:35:15 +0800
Subject: [PATCH 21/85] reduce segment size to fix memory serialization of
 vector index

---
 docker/mqdb/server.conf/users.xml | 3 ++-
 programs/server/users.xml         | 1 -
 src/Core/Settings.h               | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/docker/mqdb/server.conf/users.xml b/docker/mqdb/server.conf/users.xml
index a1d27244d1..c3888940e6 100644
--- a/docker/mqdb/server.conf/users.xml
+++ b/docker/mqdb/server.conf/users.xml
@@ -4,9 +4,10 @@
     <profiles>
         <default>
             <max_memory_usage>8000000000</max_memory_usage>
-            <serialized_index_segment_max_byte>500000000</serialized_index_segment_max_byte>
+            <serialized_index_segment_max_byte>50000000</serialized_index_segment_max_byte>
             <load_balancing>random</load_balancing>
             <log_queries>1</log_queries>
+            <allow_experimental_lightweight_delete>true</allow_experimental_lightweight_delete>
             <!-- <mutations_sync>0</mutations_sync> -->
             <!-- <replication_alter_partitions_sync>1</replication_alter_partitions_sync> -->
             <!-- <insert_distributed_sync>1</insert_distributed_sync> -->
diff --git a/programs/server/users.xml b/programs/server/users.xml
index 98e86f9857..fd5fe41457 100644
--- a/programs/server/users.xml
+++ b/programs/server/users.xml
@@ -18,7 +18,6 @@
                  first_or_random - if first replica one has higher number of errors, pick a random one from replicas with minimum number of errors.
             -->
             <load_balancing>random</load_balancing>
-            <allow_experimental_lightweight_delete>true</allow_experimental_lightweight_delete>
         </default>
 
         <!-- Profile that allows only read queries. -->
diff --git a/src/Core/Settings.h b/src/Core/Settings.h
index fe916416b8..6045bca1ec 100644
--- a/src/Core/Settings.h
+++ b/src/Core/Settings.h
@@ -172,7 +172,7 @@ class IColumn;
     M(UInt64, max_build_index_block_size_rows, 160000, "number of rows to build index in one round", 0) \
     M(UInt64, min_build_index_train_block_size, 100 * 1024 * 1024, "Minimum block size in bytes for training in build index", 0) \
     M(UInt64, max_build_index_add_block_size, 10 * 1024 * 1024, "Maximum block size in bytes for adding vectors in one round of build index", 0) \
-    M(UInt64, serialized_index_segment_max_byte, 1000000000,"the number of bytes each segment of a vector index can occupy. lower value generate more segments, resulting in longer build index time but smaller memory consumption.",0)        \
+    M(UInt64, serialized_index_segment_max_byte, 50000000, "Segment size in bytes for vector index serialization", 0) \
     M(UInt64, background_schedule_pool_size, 128, "Number of threads performing background tasks for replicated tables, dns cache updates. Only has meaning at server startup.", 0) \
     M(UInt64, background_message_broker_schedule_pool_size, 16, "Number of threads performing background tasks for message streaming. Only has meaning at server startup.", 0) \
     M(UInt64, background_distributed_schedule_pool_size, 16, "Number of threads performing background tasks for distributed sends. Only has meaning at server startup.", 0) \
-- 
2.32.1 (Apple Git-133)

