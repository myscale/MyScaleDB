From e53a0dc457193a2068aa8a7fe2a5c3e4f11754b8 Mon Sep 17 00:00:00 2001
From: Qin Liu <lqgy2001@gmail.com>
Date: Fri, 6 Jan 2023 21:18:06 +0800
Subject: [PATCH 11/85] Fix segmentation fault

---
 contrib/faiss                                   | 2 +-
 contrib/hnswlib                                 | 2 +-
 src/Processors/QueryPlan/ReadWithVectorScan.cpp | 6 +++---
 src/Storages/MergeTree/IMergeTreeDataPart.cpp   | 6 ++++++
 src/Storages/MergeTree/MergeTask.cpp            | 3 +--
 5 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/contrib/faiss b/contrib/faiss
index 0cc19348e3..3f0f442c45 160000
--- a/contrib/faiss
+++ b/contrib/faiss
@@ -1 +1 @@
-Subproject commit 0cc19348e3f0637bc19d8e77972b885356694067
+Subproject commit 3f0f442c45f34ef4cd28e15325234c3ec7fe3c63
diff --git a/contrib/hnswlib b/contrib/hnswlib
index 959436dc94..fdb835c454 160000
--- a/contrib/hnswlib
+++ b/contrib/hnswlib
@@ -1 +1 @@
-Subproject commit 959436dc94a62ddf58474a74425b033616c9a598
+Subproject commit fdb835c45492041c258d1485abb111ded0cf8867
diff --git a/src/Processors/QueryPlan/ReadWithVectorScan.cpp b/src/Processors/QueryPlan/ReadWithVectorScan.cpp
index bdaf6b9835..cef411f3d8 100644
--- a/src/Processors/QueryPlan/ReadWithVectorScan.cpp
+++ b/src/Processors/QueryPlan/ReadWithVectorScan.cpp
@@ -166,13 +166,13 @@ Pipe ReadWithVectorScan::readFromParts(
         }
 
         MarkRanges ranges;
-        MarkRange range{0, part->index_granularity.getMarksCount()};
-        ranges.emplace_back(range);
+        if (part->index_granularity.getMarksCount())
+            ranges.emplace_back(0, part->index_granularity.getMarksCount());
 
         auto source = std::make_shared<MergeTreeSelectWithVectorScanProcessor>(data, storage_snapshot, part, max_block_size, 
             preferred_block_size_bytes, preferred_max_column_in_block_size_bytes, required_columns, ranges, use_uncompressed_cache, prewhere_info,
             actions_settings, reader_settings, virt_column_names, (size_t)0, false, std::move(extension), vector_scan_manager);
-        pipes.emplace_back(std::move(source));
+        pipes.emplace_back(Pipe(std::move(source)));
     }
 
     auto pipe = Pipe::unitePipes(std::move(pipes));
diff --git a/src/Storages/MergeTree/IMergeTreeDataPart.cpp b/src/Storages/MergeTree/IMergeTreeDataPart.cpp
index 5eadb2703f..c3b15b2915 100644
--- a/src/Storages/MergeTree/IMergeTreeDataPart.cpp
+++ b/src/Storages/MergeTree/IMergeTreeDataPart.cpp
@@ -1298,6 +1298,12 @@ std::optional<ColumnPtr> IMergeTreeDataPart::readRowExistsColumn() const
 
     MergeTreeReaderSettings reader_settings;
 
+    if (getMarksCount() == 0)
+    {
+        LOG_WARNING(storage.log, "[readRowExistsColumn] skip empty part");
+        return std::nullopt;
+    }
+
     MergeTreeReaderPtr reader = getReader(
             cols,
             storage_snapshot_ptr->metadata,
diff --git a/src/Storages/MergeTree/MergeTask.cpp b/src/Storages/MergeTree/MergeTask.cpp
index a25e98943e..830dad945d 100644
--- a/src/Storages/MergeTree/MergeTask.cpp
+++ b/src/Storages/MergeTree/MergeTask.cpp
@@ -435,8 +435,7 @@ bool MergeTask::ExecuteAndFinalizeHorizontalPart::generateRowIdsMap()
         ExpressionActionsSettings actions_settings;
         MergeTreeReaderSettings reader_settings;
         MarkRanges ranges;
-        MarkRange range{0, global_ctx->future_part->parts[part_num]->index_granularity.getMarksCount()};
-        ranges.emplace_back(range);
+        ranges.emplace_back(0, global_ctx->future_part->parts[part_num]->index_granularity.getMarksCount());
 
         auto input = std::make_unique<MergeTreeInOrderSelectProcessor>(
             *global_ctx->data,
-- 
2.32.1 (Apple Git-133)

