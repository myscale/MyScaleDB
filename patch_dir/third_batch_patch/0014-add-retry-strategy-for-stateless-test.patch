From 249a8de1574735289788b597f255a154d1ab7540 Mon Sep 17 00:00:00 2001
From: shanfengp <shanfengp@moqi.ai>
Date: Fri, 17 Feb 2023 11:46:48 +0800
Subject: [PATCH 14/51] add retry strategy for stateless test

---
 docker/builder/tools/stateless-test.sh       | 8 +++++++-
 docker/builder/tools/vector-search-test.sh   | 8 +++++++-
 docker/test/mqdb_test_script/clickhouse-test | 3 +++
 3 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/docker/builder/tools/stateless-test.sh b/docker/builder/tools/stateless-test.sh
index ad3a144494..a6a270958b 100755
--- a/docker/builder/tools/stateless-test.sh
+++ b/docker/builder/tools/stateless-test.sh
@@ -1,6 +1,12 @@
 #!/usr/bin/env bash
 set -e
 
+source /etc/profile
+arch="$(dpkg --print-architecture)"
+if [[ "x$arch" = "xamd64" ]]; then
+    FORCE_RETRY="--force-retry"
+fi
+
 CUR_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
 PROJECT_PATH=$CUR_DIR/../../..
 WORKPATH=$PROJECT_PATH/docker/test/mqdb_run_stateless
@@ -16,7 +22,7 @@ cp -rfv tests/config docker/test/mqdb_run_stateless/tests/
 docker rm -f stateless-test >/dev/null 2>&1 || true
 docker build --rm=true -t run-stateless-test docker/test/mqdb_run_stateless
 
-docker run --rm --user root --volume=$WORKPATH/test_output:/test_output --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time" --name stateless-test run-stateless-test
+docker run --rm --user root --volume=$WORKPATH/test_output:/test_output --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time $FORCE_RETRY" --name stateless-test run-stateless-test
 
 docker rm -f stateless-test >/dev/null 2>&1 || true
 docker rmi -f run-stateless-test >/dev/null 2>&1 || true
diff --git a/docker/builder/tools/vector-search-test.sh b/docker/builder/tools/vector-search-test.sh
index 26e1ae400a..81e7d5befd 100755
--- a/docker/builder/tools/vector-search-test.sh
+++ b/docker/builder/tools/vector-search-test.sh
@@ -1,6 +1,12 @@
 #!/usr/bin/env bash
 set -e
 
+source /etc/profile
+arch="$(dpkg --print-architecture)"
+if [[ "x$arch" = "xamd64" ]]; then
+    FORCE_RETRY="--force-retry"
+fi
+
 CUR_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
 PROJECT_PATH=$CUR_DIR/../../..
 WORKPATH=$PROJECT_PATH/docker/test/mqdb_run_stateless
@@ -21,7 +27,7 @@ docker rm -f stateless-test >/dev/null 2>&1 || true
 docker build --rm=true -t run-stateless-test docker/test/mqdb_run_stateless
 
 # docker run --rm --user root --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time" --name stateless-test run-stateless-test
-docker run --rm --user root --volume=$WORKPATH/test_output:/test_output --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time" --name stateless-test run-stateless-test
+docker run --rm --user root --volume=$WORKPATH/test_output:/test_output --cap-add=SYS_PTRACE -e MAX_RUN_TIME=9720 -e S3_URL="https://clickhouse-datasets.s3.amazonaws.com" -e ADDITIONAL_OPTIONS="--hung-check --print-time $FORCE_RETRY" --name stateless-test run-stateless-test
 
 
 docker rm -f stateless-test >/dev/null 2>&1 || true
diff --git a/docker/test/mqdb_test_script/clickhouse-test b/docker/test/mqdb_test_script/clickhouse-test
index 417198aae5..695ae3a97d 100644
--- a/docker/test/mqdb_test_script/clickhouse-test
+++ b/docker/test/mqdb_test_script/clickhouse-test
@@ -173,6 +173,8 @@ def get_zookeeper_session_uptime(args):
 
 
 def need_retry(args, stdout, stderr, total_time):
+    if args.force_retry:
+        return True
     if args.check_zookeeper_session:
         # Sometimes we may get unexpected exception like "Replica is readonly" or "Shutdown is called for table"
         # instead of "Session expired" or "Connection loss"
@@ -1328,6 +1330,7 @@ if __name__ == '__main__':
     parser.add_argument('--no-stateful', action='store_true', help='Disable all stateful tests')
     parser.add_argument('--skip', nargs='+', help="Skip these tests")
     parser.add_argument('--sequential', nargs='+', help="Run these tests sequentially even if --parallel specified")
+    parser.add_argument('--force-retry', action='store_true', help='Force retry for fail test')
     parser.add_argument('--no-long', action='store_true', dest='no_long', help='Do not run long tests')
     parser.add_argument('--client-option', nargs='+', help='Specify additional client argument')
     parser.add_argument('--print-time', action='store_true', dest='print_time', help='Print test time')
-- 
2.32.1 (Apple Git-133)

