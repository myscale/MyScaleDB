From bd524f50cf0922f98e4f91838112ca24d494cba0 Mon Sep 17 00:00:00 2001
From: Qin Liu <lqgy2001@gmail.com>
Date: Tue, 27 Jun 2023 20:31:45 +0800
Subject: [PATCH 2/7] Bug fix: MR271

---
 contrib/search-index                                  |  2 +-
 docker/test/mqdb_run_stateless/run.sh                 |  1 +
 src/Storages/MergeTree/MergeTreeVectorScanManager.cpp | 10 +++-------
 src/VectorIndex/PartReader.cpp                        |  5 ++++-
 4 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/contrib/search-index b/contrib/search-index
index 7240877fbc..a08f7085f1 160000
--- a/contrib/search-index
+++ b/contrib/search-index
@@ -1 +1 @@
-Subproject commit 7240877fbc7577cbe668ecfe5e219484d2ddbd8c
+Subproject commit a08f7085f14590b11baaa6256f6a4f7c47312224
diff --git a/docker/test/mqdb_run_stateless/run.sh b/docker/test/mqdb_run_stateless/run.sh
index 4e21d31642..f584c2a4a5 100644
--- a/docker/test/mqdb_run_stateless/run.sh
+++ b/docker/test/mqdb_run_stateless/run.sh
@@ -137,6 +137,7 @@ function run_tests() {
         01154_move_partition_long 01076_parallel_alter_replicated_zookeeper 01172_transaction_counters \
         01079_parallel_alter_detach_table_zookeeper 01193_metadata_loading \
         01103_check_cpu_instructions_at_startup \
+        02125_many_mutations \
         2>&1 |
         ts '%Y-%m-%d %H:%M:%S' |
         tee -a test_output/test_result.txt
diff --git a/src/Storages/MergeTree/MergeTreeVectorScanManager.cpp b/src/Storages/MergeTree/MergeTreeVectorScanManager.cpp
index 7c1d0a01dd..cf7c9c526d 100644
--- a/src/Storages/MergeTree/MergeTreeVectorScanManager.cpp
+++ b/src/Storages/MergeTree/MergeTreeVectorScanManager.cpp
@@ -1129,9 +1129,9 @@ VectorScanResultPtr MergeTreeVectorScanManager::vectorScanWithoutIndex(
                     {
                         if (!col_data[i])
                         {
-                            LOG_DEBUG(log, "Unset: {}", num_rows_read + i);
+                            LOG_DEBUG(log, "Unset: {}", i);
                             ++deleted_row_num;
-                            row_exists->unset(num_rows_read + i);
+                            row_exists->unset(i);
                         }
                     }
                 }
@@ -1276,11 +1276,7 @@ void MergeTreeVectorScanManager::searchWrapper(
             while (curr_pos < k && tmp_curr_pos < k + delete_id_num)
             {
                 auto & tmp_id = tmp_per_id[i * (k + delete_id_num) + tmp_curr_pos];
-                if (tmp_id < 0)
-                {
-                    LOG_ERROR(log, "tmp_id: {}, num_rows_read: {}", tmp_id, num_rows_read);
-                }
-                else if (tmp_id >= 0 && row_exists->is_member(tmp_id + num_rows_read))
+                if (tmp_id >= 0 && row_exists->is_member(tmp_id))
                 {
                     per_id[i * k + curr_pos] = tmp_per_id[i * (k + delete_id_num) + tmp_curr_pos];
                     per_distance[i * k + curr_pos] = tmp_per_distance[i * (k + delete_id_num) + tmp_curr_pos];
diff --git a/src/VectorIndex/PartReader.cpp b/src/VectorIndex/PartReader.cpp
index f7c0f4ffe0..9198772ecc 100644
--- a/src/VectorIndex/PartReader.cpp
+++ b/src/VectorIndex/PartReader.cpp
@@ -71,7 +71,10 @@ std::shared_ptr<PartReader::DataChunk> PartReader::sampleData(size_t n)
         chunks.push_back(chunk);
     }
     reset();
-    return merge(chunks);
+    auto ret = merge(chunks);
+    if (ret == nullptr)
+        throw DB::Exception("Cannot sample data from part " + part->name, DB::ErrorCodes::INCORRECT_DATA);
+    return ret;
 }
 
 size_t PartReader::numDataRead() const
-- 
2.32.1 (Apple Git-133)

