From 03fcd462318049c1428625ea309ffeef2c305807 Mon Sep 17 00:00:00 2001
From: Yi Ma <yim@moqi.ai>
Date: Mon, 26 Jun 2023 15:39:42 +0800
Subject: [PATCH 1/7] set build type to RelWithDebInfo

---
 .gitlab-ci-build.yml |  4 ++--
 .gitlab-ci.yml       | 17 ++++++++---------
 2 files changed, 10 insertions(+), 11 deletions(-)

diff --git a/.gitlab-ci-build.yml b/.gitlab-ci-build.yml
index ec1aeb8163..bb5d1858d5 100644
--- a/.gitlab-ci-build.yml
+++ b/.gitlab-ci-build.yml
@@ -21,11 +21,11 @@ build_binary:
   script:
     - ssh-keyscan -H git.moqi.ai > ~/.ssh/known_hosts
     - docker/builder/tools/submodule-update.sh
-    - docker/builder/build.py --output artifacts --arch linux-x86_64 --package
+    - docker/builder/build.py --output artifacts --build-type RelWithDebInfo --arch linux-x86_64 --package
     - cp build/programs/clickhouse artifacts/.
     - docker/builder/tools/package_performance.sh all
     - tar -zcf performance_pack_amd64.tar.gz performance_pack
-    # - docker/builder/build.py --output artifacts --arch linux-aarch64 --package
+    # - docker/builder/build.py --output artifacts --build-type RelWithDebInfo --arch linux-aarch64 --package
     - mv performance_pack_amd64.tar.gz artifacts/.
   rules:
     - if: '$CI_TEST_IN_K8S == "false"'
diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index 0e147b56e9..f6eb7ff416 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -94,8 +94,8 @@ build_package:
   script:
     - ssh-keyscan -H git.moqi.ai >> ~/.ssh/known_hosts
     - docker/builder/tools/submodule-update.sh
-    - docker/builder/build.py --output artifacts --profile release --arch linux-x86_64 --package
-    - docker/builder/build.py --output artifacts --profile release --arch linux-aarch64 --package
+    - docker/builder/build.py --output artifacts --build-type RelWithDebInfo --profile release --arch linux-x86_64 --package
+    - docker/builder/build.py --output artifacts --build-type RelWithDebInfo --profile release --arch linux-aarch64 --package
   rules:
     - if: $CI_PIPELINE_SOURCE == "schedule"
     - when: manual
@@ -118,12 +118,12 @@ build_package_with_license:
   script:
     - ssh-keyscan -H git.moqi.ai >> ~/.ssh/known_hosts
     - docker/builder/tools/submodule-update.sh
-    - docker/builder/build.py --output artifacts --profile release_with_license --arch linux-x86_64 --package
-    - docker/builder/build.py --output artifacts --profile release_with_license --arch linux-aarch64 --package
+    - docker/builder/build.py --output artifacts --build-type RelWithDebInfo --profile release_with_license --arch linux-x86_64 --package
+    - docker/builder/build.py --output artifacts --build-type RelWithDebInfo --profile release_with_license --arch linux-aarch64 --package
 
 build_image:
   stage: image
-  dependencies: ["build_package","check_pipeline_already_running"]
+  dependencies: ["build_package", "check_pipeline_already_running"]
   before_script:
     - if [[ -f previous_pipeline_status.txt ]]; then
       exit 0;
@@ -140,7 +140,7 @@ build_image:
 build_saas_image:
   stage: image
   when: manual
-  dependencies: ["build_package","check_pipeline_already_running"]
+  dependencies: ["build_package", "check_pipeline_already_running"]
   before_script:
     - docker/builder/tools/docker-info.sh
     - docker/builder/tools/docker-buildx.sh
@@ -149,7 +149,7 @@ build_saas_image:
 
 upload_performance_file_to_s3:
   stage: deploy
-  dependencies: ["build_binary","check_pipeline_already_running"]
+  dependencies: ["build_binary", "check_pipeline_already_running"]
   image:
     name: minio/mc
     entrypoint: [""]
@@ -170,7 +170,7 @@ flag_pipeline_status:
   image: harbor.internal.moqi.ai/mqdb/redis:7.0.10
   # rules:
   #   - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_TEST_IN_K8S == "false"'
-    # - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_IN_K8S == "false"'
+  # - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_IN_K8S == "false"'
   script:
     - if [ ! -n "$REDIS_HOST" ]; then echo "redis host unknown, Run the pipeline by default."; exit 0; fi
     - KEY_TIMEOUT=${EXPIRE_TIME:-604800}
@@ -179,4 +179,3 @@ flag_pipeline_status:
     - redis-cli -h ${REDIS_HOST} EXPIRE ${PIPELINE_UNIQUE_KEY} ${KEY_TIMEOUT}
   rules:
     - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_TEST_IN_K8S == "false"'
-
-- 
2.32.1 (Apple Git-133)

